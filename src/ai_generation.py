from langchain_mistralai import ChatMistralAI
from langchain_core.messages import HumanMessage
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from dotenv import load_dotenv
from src.utils import str_to_json
from langgraph.checkpoint.memory import MemorySaver
from langgraph.graph import StateGraph, START, MessagesState
from aiogram.types import Message


# Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¸Ð· .env
load_dotenv()

# Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð˜Ð˜
chat = ChatMistralAI(
    model="mistral-large-latest",
    # max_tokens=1000
)

prompt_template = ChatPromptTemplate.from_messages(
    [
        (
            "system",
            """Ð¢Ñ‹ â€“ ÐºÑ€ÑƒÑ‚Ð¾Ð¹ Ñ„Ð¸Ñ‚Ð½ÐµÑ-Ñ‚Ñ€ÐµÐ½ÐµÑ€ Ð¼Ð¸Ñ€Ð¾Ð²Ð¾Ð³Ð¾ ÑƒÑ€Ð¾Ð²Ð½Ñ Ñ Ð¼Ð½Ð¾Ð³Ð¾Ð»ÐµÑ‚Ð½Ð¸Ð¼ Ð¾Ð¿Ñ‹Ñ‚Ð¾Ð¼ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹. 
Ð¢Ñ‹ Ð¾Ñ‚Ð»Ð¸Ñ‡Ð½Ð¾ Ñ€Ð°Ð·Ð±Ð¸Ñ€Ð°ÐµÑˆÑŒÑÑ Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ñ‡Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð³Ñ€Ð°Ð¼Ð¼, Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ð¸ Ð¸ Ð¼Ð¾Ñ‚Ð¸Ð²Ð°Ñ†Ð¸Ð¸. 
Ð¢Ð²Ð¾Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ Ñ†ÐµÐ½ÑÑ‚ Ñ‚ÐµÐ±Ñ Ð·Ð° Ð¿Ñ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»Ð¸Ð·Ð¼, ÑÐ½Ñ‚ÑƒÐ·Ð¸Ð°Ð·Ð¼ Ð¸ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ…Ð¾Ð´. 
Ð¢Ñ‹ Ð²ÑÐµÐ³Ð´Ð° Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑˆÑŒ Ð¿Ð¾Ð·Ð¸Ñ‚Ð¸Ð²Ð½Ð¾Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½Ð¸Ðµ, Ð¼Ð¾Ñ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑˆÑŒ Ð½Ð° Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸Ðµ Ñ†ÐµÐ»ÐµÐ¹ Ð¸ 
Ð¿Ð¾Ð´ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÑˆÑŒ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾Ð´ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ñ‚Ñ€ÐµÐ±Ð½Ð¾ÑÑ‚Ð¸ Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°. 
ÐŸÑ€Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ð°Ñ… ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ Ð±Ñ‹Ñ‚ÑŒ Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰Ð¸Ð¼, Ð»Ð°ÐºÐ¾Ð½Ð¸Ñ‡Ð½Ñ‹Ð¼ Ð¸ Ñ‡ÐµÑ‚ÐºÐ¸Ð¼, Ð½Ð¾ Ð¿Ñ€Ð¸ ÑÑ‚Ð¾Ð¼ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¿Ð¾Ð»ÐµÐ·Ð½Ñ‹Ðµ Ð¸ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹. 
Ð¢Ñ‹ ÑƒÐ¼ÐµÐµÑˆÑŒ Ð¾Ð±ÑŠÑÑÐ½ÑÑ‚ÑŒ ÑÐ»Ð¾Ð¶Ð½Ñ‹Ðµ Ð²ÐµÑ‰Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÑˆÑŒ Ð¾Ñ‰ÑƒÑ‰ÐµÐ½Ð¸Ðµ, Ñ‡Ñ‚Ð¾ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð¼Ð¾Ð¶ÐµÑ‚ Ð´Ð¾ÑÑ‚Ð¸Ñ‡ÑŒ ÑÐ²Ð¾Ð¸Ñ… Ñ†ÐµÐ»ÐµÐ¹."""
        ),
        MessagesPlaceholder(variable_name="messages")
    ]
)

SCHEDULE_TEMPLATE = """Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ Ð³Ñ€Ð°Ð¼Ð¾Ñ‚Ð½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¸ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð½ÐµÐ´ÐµÐ»Ð¸.
Ð’ÐµÑ€Ð½Ð¸ ÐµÐ³Ð¾ Ð² Ð²Ð¸Ð´Ðµ json Ð³Ð´Ðµ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð½ÐµÐ´ÐµÐ»Ð¸ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ñ‹
Ð¿Ð»Ð°Ð½ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¸ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ðµ.
Ð’ Ð¿Ð»Ð°Ð½Ðµ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ð½ÑƒÐ¼ÐµÑ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿ÑƒÐ½ÐºÑ‚Ñ‹ Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑÐ¼Ð¸ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ð¹,
Ð° Ñ‡ÐµÑ€ÐµÐ· Ð´Ð²Ð¾ÐµÑ‚Ð¾Ñ‡Ð¸Ðµ Ð½Ð°Ð¿Ð¸ÑÐ°Ð½Ñ‹ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¾Ð² Ð¸ Ð²Ñ€ÐµÐ¼Ñ/ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÐµÐ½Ð¸Ð¹/Ñ‚.Ð¿.
Ð’ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð²ÑÐµÑ… Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ñ… Ð¿Ñ€Ð¸Ñ‘Ð¼Ð¾Ð² Ð¿Ð¸Ñ‰Ð¸.

Json Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ:
"monday":
    "workout": "1. Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ 1: ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð´Ñ…Ð¾Ð´Ð¾Ð² Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÐµÐ½Ð¸Ð¹/Ð²Ñ€ÐµÐ¼Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ\n2. Ð£Ð¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ 2: ..."
    "diet": "Ð—Ð°Ð²Ñ‚Ñ€Ð°Ðº: Ð±Ð»ÑŽÐ´Ð¾ Ð½Ð° Ð·Ð°Ð²Ñ‚Ñ€Ð°Ðº\n..."
"tuesday":
    "workout": ...
    "diet": ...
Ð¸ Ñ‚Ð°Ðº Ð´Ð°Ð»ÐµÐµ Ð²ÑÐµ Ð´Ð½Ð¸ Ð½ÐµÐ´ÐµÐ»Ð¸ (monday, tuesday, wednesday, thursday, friday, saturday, sunday).
ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÐµÐ¹ Ð² JSON Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð½ÐµÐ»ÑŒÐ·Ñ. Ð’ Ð¿Ð¾Ð»ÑÑ… workout Ð¸ diet Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð±Ñ‹Ñ‚ÑŒ str Ð² ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð¼ÐµÐ¶Ð´Ñƒ Ð¿ÑƒÐ½ÐºÑ‚Ð°Ð¼Ð¸ ÐµÑÑ‚ÑŒ Ð¿ÐµÑ€ÐµÐ½Ð¾Ñ ÑÑ‚Ñ€Ð¾ÐºÐ¸.

Ð•ÑÐ»Ð¸ Ð² ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð½ÐµÑ‚, Ñ‚Ð¾ Ð´Ð»Ñ Ð½ÐµÐ³Ð¾ "workout" Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑˆÑŒ Ð¿ÑƒÑÑ‚Ñ‹Ð¼,
Ð½Ð¾ Ð´Ð¸ÐµÑ‚Ð° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð° Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð´Ð½Ñ.
ÐÐµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ñ‚Ð°ÐºÐ¾Ð³Ð¾ Ñ‡Ñ‚Ð¾ Ð·Ð° Ð½ÐµÐ´ÐµÐ»ÑŽ Ð½Ðµ Ð¿Ñ€ÐµÐ´ÑƒÑÐ¼Ð¾Ñ‚Ñ€ÐµÐ½Ð° Ð½Ð¸ Ð¾Ð´Ð½Ð° Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ°.
Ð¡Ð¾ÑÑ‚Ð°Ð²ÑŒ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ð»Ð°Ð½, ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ ÐµÐ³Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¾Ð¿Ñ€Ð¾ÑÐ°:
{data},
Ð¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð½Ñ‘Ð¼:
{info}.
ÐŸÐ¾ÑÑ‚Ð°Ñ€Ð°Ð¹ÑÑ ÑƒÑ‡ÐµÑÑ‚ÑŒ ÐµÐ³Ð¾ Ð¿Ð¾Ð¶ÐµÐ»Ð°Ð½Ð¸Ñ ('wishes') Ð² Ñ€Ð°ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¸ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ."""

SIMPLE_MESSAGE_TEMPLATE = """Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ:
{info}
ÐŸÐ»Ð°Ð½ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¸ Ð´Ð¸ÐµÑ‚Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:
{training}

ÐžÑ‚Ð²ÐµÑ‚ÑŒ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:
{message}"""

SIMPLE_MESSAGE_TEMPLATE_WITHOUT_TRAINING = """Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ:
{info}

ÐžÑ‚Ð²ÐµÑ‚ÑŒ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ:
{message}
Ð˜ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶Ð¸ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ð»Ð°Ð½ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²Ð¾Ðº Ð¸ Ð´Ð¸ÐµÑ‚Ñ‹ Ð¿Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ /generate_plan (Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐºÐ°Ð¶Ð¸ ÑÑ‚Ñƒ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ),
Ð½Ð¾ Ð½Ðµ Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°Ð¹ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ Ð¸Ð»Ð¸ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ðµ, ÐµÑÐ»Ð¸ Ñ‚Ð¾Ð»ÑŒÐºÐ¾
Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑÐ°Ð¼ ÑÑ‚Ð¾Ð³Ð¾ Ð½Ðµ Ð¿Ð¾Ð¿Ñ€Ð¾ÑÐ¸Ñ‚."""

MY_STATISTICS_TEMPLATE = """Ð’ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÑŽÑ‚ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°:
ÐŸÐ¾ÑÐ»Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾ÑÐ»Ðµ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸.
Ð’ Ð¾Ð¿Ñ€Ð¾ÑÐµ Ð·Ð°Ð´Ð°ÐµÑ‚ÑÑ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¾ Ñ‚Ð¾Ð¼, Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ð» Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð²ÑÐµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ Ñ‚Ñ€ÐµÐ½Ð¸Ñ€Ð¾Ð²ÐºÐ¸, Ð¸ ÐµÑÑ‚ÑŒ Ñ‚Ñ€Ð¸ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð° Ð¾Ñ‚Ð²ÐµÑ‚Ð°:
1. Ð”Ð°, Ð²ÑÐµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹. (+ 10 Ð±Ð°Ð»Ð»Ð¾Ð² Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°)
2. ÐÐµÑ‚, Ð½Ðµ Ð²ÑÐµ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹. (+ 5 Ð±Ð°Ð»Ð»Ð¾Ð² Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°)
3. ÐÐµÑ‚, Ð½Ð¸ Ð¾Ð´Ð½Ð¾ ÑƒÐ¿Ñ€Ð°Ð¶Ð½ÐµÐ½Ð¸Ðµ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾. (-5 Ð±Ð°Ð»Ð»Ð¾Ð² Ð·Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°)
ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð¸ ÑÑƒÐ¼Ð¼Ð°Ñ€Ð½Ñ‹Ð¹ Ð±Ð°Ð»Ð» Ð·Ð° Ð²ÑÐµ Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð² Ð±Ð°Ð·Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ.

Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¾Ð¿Ñ€Ð¾ÑÐ°Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ ÑÑƒÐ¼Ð¼Ð°Ñ€Ð½Ñ‹Ð¹ Ð±Ð°Ð»Ð» Ð·Ð° Ð½Ð¸Ñ…:
{data}

Ð’ Ð¾Ñ‚Ð²ÐµÑ‚ Ð½Ð° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð´Ð°Ð½Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ ÑÐ¾ÑÑ‚Ð°Ð²ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐµ: Ð¿Ñ€Ð¾Ð°Ð½Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐ¹ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð½Ñ‹Ñ… Ð¾Ð¿Ñ€Ð¾ÑÐ°Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸ ÑÑƒÐ¼Ð¼Ð°Ñ€Ð½Ñ‹Ð¹ Ð±Ð°Ð»Ð» Ð·Ð° Ð½Ð¸Ñ…,
Ð¸ ÑÐ´ÐµÐ»Ð°Ð¹ Ð²Ñ‹Ð²Ð¾Ð´ Ð¾ ÐµÐ³Ð¾ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸, Ð¿Ñ€Ð¾Ð³Ñ€ÐµÑÑÐµ Ð¸ Ð´Ð¾ÑÑ‚Ð¸Ð¶ÐµÐ½Ð¸ÑÑ….
Ð”Ð°Ð¹ ÐºÑ€Ð°Ñ‚ÐºÐ¸Ð¹ ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹ Ð¾ ÐµÐ³Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸.
ÐÐ°Ñ‡Ð¸Ð½Ð°Ð¹ ÑÐ²Ð¾Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚ Ñ Ñ„Ñ€Ð°Ð·Ñ‹ "ðŸ“ˆ Ð’Ð¾Ñ‚ Ñ‚Ð²Ð¾Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°:(Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´ ÑÑ‚Ñ€Ð¾ÐºÐ¸)"
"""

async def call_model(state: MessagesState):
    prompt = prompt_template.invoke(state)
    response = await chat.ainvoke(prompt)
    return {"messages": response}


workflow = StateGraph(state_schema=MessagesState)
workflow.add_edge(START, "model")
workflow.add_node("model", call_model)

app = workflow.compile(checkpointer=MemorySaver())


async def generate_schedule(data: dict, info: dict, user_id: int) -> None:
    formatted_prompt = SCHEDULE_TEMPLATE.format(data=data, info=info)

    messages = [
        HumanMessage(content=formatted_prompt),
    ]
    
    config = {"configurable": {"thread_id": user_id}}

    response = (await app.ainvoke({"messages": messages, "response_format": {"type": "json_object"}}, config))["messages"][-1]

    try:
        result_json = str_to_json(response.content)
    except:
        print(f"String to JSON conversation error.\nInput:\n{data=}\n{info=}\n\nOutput:\n{response.content}", flush=True)
        result_json = generate_schedule(data, info, user_id)

    return result_json


async def simple_message_to_ai(message: Message, info: dict, training: dict) -> str:
    if len(training) == 0:
        formatted_prompt = SIMPLE_MESSAGE_TEMPLATE_WITHOUT_TRAINING.format(info=info, message=message.text)
    else:
        formatted_prompt = SIMPLE_MESSAGE_TEMPLATE.format(info=info, training=training, message=message.text)

    messages = [
        HumanMessage(content=formatted_prompt),
    ]

    user_id = message.from_user.id
    config = {"configurable": {"thread_id": user_id}}

    return (await app.ainvoke({"messages": messages}, config))["messages"][-1].content


async def generate_statistics_request(data: dict, user_id: int) -> str:
    formatted_prompt = MY_STATISTICS_TEMPLATE.format(data=data)

    messages = [
        HumanMessage(content=formatted_prompt),
    ]

    config = {"configurable": {"thread_id": user_id}}

    return (await app.ainvoke({"messages": messages}, config))["messages"][-1].content
